---
description: Documents GPU optimization algorithms including memory distribution, tensor parallel splits, and allocation strategies.
globs: ./**/optimizer.py,./**/gpu_info.py,./**/batch/*.py,./**/commands/*.py,./**/memory/*.py
alwaysApply: false
---


# gpu-optimization-algorithms

The GPU optimization system implements specialized algorithms for memory management and workload distribution across multiple GPUs:

## Memory Distribution Algorithm
File: dualgpuopt/optimizer.py

- Calculate optimal GPU memory splits based on model architecture:
  - KV cache requirements for transformer layers  
  - Hidden state memory allocation
  - Attention mechanism memory patterns
  - Special handling for MoE architectures (Mixtral)
- Memory distribution scaled by:
  - Available VRAM per GPU
  - Model parameter count
  - Sequence context length 
  - Data precision format

## Tensor Parallel Splits
File: dualgpuopt/batch/smart_batch.py

- Dynamic batch size calculation:
  - Length-aware sequence grouping
  - Token count thresholds per GPU
  - Backpressure on OOM events (-25% batch size)
  - Gradual recovery after successful batches
- Layer distribution algorithm:
  - Balance layers across GPUs based on profiled speeds
  - Contiguous block optimization
  - Minimize cross-GPU communications

## Memory Allocation Strategy 
File: dualgpuopt/memory/predictor.py

- Model-specific memory profiles:
  - Base memory requirements
  - Per-token memory scaling 
  - Growth rate projection
  - Recovery buffer settings
- Memory recovery tiers:
  1. Cache clearing
  2. Batch reduction
  3. Model offloading
  4. Process termination

## Framework Command Generation
File: dualgpuopt/commands/gpu_commands.py

- llama.cpp optimization:
  - GPU layer distribution
  - Split ratio calculation 
  - Thread allocation
- vLLM deployment:
  - Tensor parallel sizing
  - Memory allocation strategy
  - Environment configuration

The algorithms focus on optimizing model deployment across multiple GPUs while managing memory constraints and performance characteristics.

$END$